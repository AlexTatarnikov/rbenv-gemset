#!/usr/bin/env bash -e

case "$1" in
"create")
  RBENV_VERSION="$2"
  if [ -z "${RBENV_VERSION}" ]; then
    echo "you must specify an installed version to associate the gemset with" >&2
    echo "available versions are:"
    rbenv versions
    exit 1
  fi

  rbenv prefix "${RBENV_VERSION}" > /dev/null # make sure the provided version exists
    
  RBENV_GEMSET="$3"
  if [ -z "${RBENV_GEMSET}" ]; then
    echo "you must specify a name for the new gemset" >&2
    exit 1
  fi

  RBENV_GEMSET_PATH="$(rbenv prefix "${RBENV_VERSION}")/gemsets/${RBENV_GEMSET}"

  mkdir -p "${RBENV_GEMSET_PATH}"
  echo "created ${RBENV_GEMSET} for ${RBENV_VERSION}"
  ;;

"delete")
  RBENV_VERSION="$2"
  RBENV_GEMSET="$3"
  if [[ -z "${RBENV_VERSION}" || -z "${RBENV_GEMSET}" ]]; then
    echo "you must specify a version and it's associated gemset" >&2
    exit 1
  fi

  rm -rf "$(rbenv prefix "${RBENV_VERSION}")/gemsets/${RBENV_GEMSET}"
  echo "deleted ${RBENV_GEMSET} from ${RBENV_VERSION}"
  ;;

"install")
  if [ "$2" == "-g" ]; then
    RBENV_PLUGIN_ROOT=/tmp/rbenv.d
  else
    RBENV_PLUGIN_ROOT="${HOME}/.rbenv/rbenv.d"
  fi

  RBENV_PLUGIN_PATH="${RBENV_PLUGIN_ROOT}/exec"
  mkdir -p "${RBENV_PLUGIN_PATH}"

  cat > "${RBENV_PLUGIN_PATH}/gemset.bash" <<-'PLUGIN'
find_gemset_file() {
  local root="$(pwd)"
  while [ -n "$root" ]; do
    if [ -e "${root}/.rbenv-gemsets" ]; then
      echo "${root}/.rbenv-gemsets"
      return 0
    fi
    root="${root%/*}"
  done
  return 1
}

unset GEM_HOME GEM_PATH
RBENV_GEMSET_FILE="$(find_gemset_file || true)"

if [ -n "$RBENV_GEMSET_FILE" ]; then
  RBENV_GEMSET_ROOT="$(rbenv prefix)/gemsets"
  for gemset in `cat "$RBENV_GEMSET_FILE"`
  do
    path="${RBENV_GEMSET_ROOT}/${gemset}"
    if [ -z "${GEM_HOME}" ]; then
      GEM_HOME=$path
      GEM_PATH=$path
    else
      GEM_PATH=$GEM_PATH:$path
    fi
  done

  export GEM_HOME GEM_PATH
fi
PLUGIN

  echo "rbenv-gemset plugin installed"
  ;;

*)
  echo "$0 create [version] [gemset]" >&2
  echo "$0 delete [version] [gemset]" >&2
  echo "$0 install [-g]" >&2
  exit 1
  ;;
esac
